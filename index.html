**Light adjustments for features and UI**

Okay, we need to add a button to the dashboard that lets you add a misc profit through the report controls. For excluding "Walk-in" customers from the ledger, I’ll filter them out when rendering the customer list. Reports where customers are marked as "Walk-in" can still include that name though, as it seems it's fine for those. As for the logo upload, I'll replace the text input with a file input in settings, and remove the top-bar logo, only keeping it for the bill. Let’s get started!
```html
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>SWAN-ERP Final</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
<style>
/* CORE VARIABLES & THEMES */
:root {
  --bg-main: #0f172a; --bg-soft: #1e293b; --border: #334155;
  --accent: #3b82f6; --accent-soft: #60a5fa; --text: #f1f5f9;
  --muted: #94a3b8; --danger: #ef4444; --warn: #f59e0b; --success: #22c55e;
  --brand-font: 'Segoe UI', system-ui, sans-serif;
}
body.theme-green { --accent: #22c55e; --accent-soft: #4ade80; background: linear-gradient(180deg,#062014,#0f2b18); --brand-font: 'Segoe UI', system-ui, sans-serif; }
body.theme-orange { --accent: #f97316; --accent-soft: #fb923c; background: linear-gradient(180deg,#2b0f05,#3d1608); --brand-font: 'Segoe UI', system-ui, sans-serif; }
body.theme-red { --accent: #ef4444; --accent-soft: #f87171; background: linear-gradient(180deg,#2b0a0a,#3a0f0f); --brand-font: 'Segoe UI', system-ui, sans-serif; }
body.theme-paper { --accent: #1f2937; --accent-soft: #374151; --bg-main: #f8fafc; --bg-soft: #ffffff; --text: #0f172a; --muted:#64748b; --border:#e2e8f0; --brand-font: 'Georgia', 'Times New Roman'; }
body.theme-default { --brand-font: 'Segoe UI', system-ui, sans-serif; }
body.theme-slate { --bg-main:#0b1220; --bg-soft:#0f1724; --accent:#7c3aed; --accent-soft:#a78bfa; --text:#e6eef8; --muted:#9aa8bf; --border:#172033;}
body.theme-cool { --bg-main:#041428; --bg-soft:#07213a; --accent:#06b6d4; --accent-soft:#67e8f9; --text:#e6f7fb; --muted:#87a6b8; --border:#083048;}
body.theme-sun { --bg-main:#251100; --bg-soft:#3b1f00; --accent:#ffb020; --accent-soft:#ffd580; --text:#fff6ec; --muted:#b58b6a; --border:#4a2600;}
* { box-sizing: border-box; outline: none; }
html, body { margin: 0; padding: 0; font-family: var(--brand-font); background: var(--bg-main); color: var(--text); height: 100%; overflow: hidden; }

/* LAYOUT */
.app-shell { display: flex; flex-direction: column; height: 100vh; }

/* TOP BAR */
.top-bar { display: flex; justify-content: space-between; align-items: center; padding: 0 15px; height: 56px; background: var(--bg-soft); border-bottom: 1px solid var(--border); font-size: 0.95rem; }
.brand { font-weight: 800; letter-spacing: 1px; color: var(--accent-soft); display:flex; align-items:center; gap:10px; }
/* Hide POS UI logo per request: logo only on bill */
.brand img { display:none !important; height:36px; width:36px; border-radius:6px; object-fit:cover; }

/* RIBBON NAV */
.ribbon { display: flex; gap: 5px; padding: 8px 10px; background: var(--bg-main); border-bottom: 1px solid var(--border); overflow-x: auto; }
.ribbon-btn {
  padding: 8px 14px; background: var(--bg-soft); border: 1px solid var(--border);
  color: var(--muted); border-radius: 6px; cursor: pointer; font-size: 0.75rem;
  display: flex; align-items: center; gap: 8px; transition: 0.2s; white-space: nowrap; font-weight: 600; text-transform: uppercase;
}
.ribbon-btn:hover { border-color: var(--accent); color: var(--text); }
.ribbon-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
.ribbon-sep { width: 1px; background: var(--border); margin: 0 5px; }

/* MAIN VIEW AREA */
.main-area { flex: 1; overflow: hidden; position: relative; padding: 10px; }
.view { display: none; flex-direction: column; height: 100%; animation: fadein 0.2s; }
.view.active { display: flex; }
@keyframes fadein { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

/* COMMON UI ELEMENTS */
.panel { background: var(--bg-soft); border: 1px solid var(--border); border-radius: 8px; padding: 12px; display: flex; flex-direction: column; gap: 10px; }
.row { display: flex; gap: 10px; } .col { flex: 1; }
.field { display: flex; flex-direction: column; gap: 4px; margin-bottom: 5px; }
.field label { font-size: 0.7rem; text-transform: uppercase; color: var(--muted); letter-spacing: 0.5px; }

input, select, textarea {
  background: #020617; border: 1px solid var(--border); color: var(--text);
  padding: 8px; border-radius: 4px; font-size: 0.9rem; width: 100%;
}
body.theme-paper input, body.theme-paper select, body.theme-paper textarea { background:#fff; color:var(--text); }
input:focus, select:focus { border-color: var(--accent); }

/* TABLES */
.table-container { flex: 1; overflow: hidden; border: 1px solid var(--border); border-radius: 6px; background: #020617; display: flex; flex-direction: column; }
.table-scroll { overflow-y: auto; flex: 1; }
table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
th, td { padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--border); }
th { background: var(--bg-soft); color: var(--muted); position: sticky; top: 0; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; z-index:2; }
tr:hover td { background: rgba(255,255,255,0.03); }
.text-right { text-align: right; }
.text-danger { color: var(--danger) !important; }

/* BUTTONS */
.btn { padding: 8px 16px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-soft); color: var(--text); cursor: pointer; font-size: 0.8rem; font-weight: 600; display: inline-flex; align-items:center; gap:8px; }
.btn:hover { border-color: var(--accent); color: var(--accent-soft); }
.btn-primary { background: var(--accent); color: white; border-color: var(--accent); }
.btn-primary:hover { background: var(--accent-soft); color: white; }
.btn-danger { background: var(--danger); border-color: var(--danger); color: white; }
.btn-block { width: 100%; }
.btn-sm { padding: 4px 8px; font-size: 0.75rem; }

/* DASHBOARD GRID */
.dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
.tile { background: var(--bg-soft); border: 1px solid var(--border); padding: 16px; border-radius: 8px; display: flex; flex-direction: column; gap: 4px; }
.tile-head { font-size: 0.75rem; text-transform: uppercase; color: var(--muted); }
.tile-val { font-size: 1.5rem; font-weight: 700; color: var(--accent-soft); }
.tile-sub { font-size: 0.7rem; color: var(--muted); }
.report-bar { background: var(--bg-soft); border: 1px solid var(--border); padding: 15px; border-radius: 8px; margin-top: auto; }
.report-controls { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; }

/* POS SPECIFIC */
.pos-layout { display: grid; grid-template-columns: 280px 1fr 320px; gap: 10px; height: 100%; }
.pos-totals { margin-top: auto; border-top: 1px dashed var(--border); padding-top: 10px; }
.pos-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.9rem; }
.grand-total { font-size: 1.6rem; font-weight: bold; color: var(--accent-soft); text-align: right; margin: 10px 0; }
/* Keep total controls sticky so they don't disappear when cart grows */
.pos-controls { position: sticky; bottom: 12px; background: transparent; padding-top: 10px; z-index: 3; }

/* MODAL */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
.modal { background: var(--bg-main); width: 600px; max-width: 95vw; padding: 20px; border-radius: 8px; border: 1px solid var(--accent); display: flex; flex-direction: column; gap: 15px; box-shadow: 0 6px 26px rgba(0,0,0,0.6); }
.modal-head { display: flex; justify-content: space-between; align-items: center; font-size: 1.1rem; font-weight: bold; color: var(--accent-soft); border-bottom: 1px solid var(--border); padding-bottom:8px; }

/* PRINT HIDDEN */
#print-zone { display: none; }
@media print {
  .app-shell, .modal-overlay { display: none !important; }
  #print-zone { display: block !important; position: absolute; top: 0; left: 0; width: 100%; background: #fff; color: #000; padding: 10px; }
  .print-header { text-align: center; margin-bottom: 20px; }
  .print-header img { max-height: 60px; display:block; margin: 0 auto 6px; }
  table.print-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  table.print-table th, table.print-table td { border: 1px solid #ddd; padding: 6px; text-align: left; }
}
.hidden { display:none; }
.small-muted { font-size: 0.75rem; color: var(--muted); }
</style>
</head>
<body class="theme-default">
<div class="app-shell">
<header class="top-bar">
  <div class="brand">
    <!-- POS UI logo hidden per request -->
    <img id="brand-logo" alt="Swan Logo">
    <div><span style="display:block;font-size:1.05rem">SWAN-ERP</span><small class="small-muted">Retail & Inventory</small></div>
  </div>
  <div style="display:flex; gap:15px; align-items:center;">
    <span id="clock" style="color:var(--muted); font-family:monospace;">00:00:00</span>
    <select id="theme-selector" style="width:auto; padding:4px;" onchange="setTheme(this.value)">
      <option value="theme-default">Default</option>
      <option value="theme-green">Forest</option>
      <option value="theme-orange">Sunset</option>
      <option value="theme-red">Crimson</option>
      <option value="theme-paper">Paper</option>
      <option value="theme-slate">Slate</option>
      <option value="theme-cool">Cool</option>
      <option value="theme-sun">Sunrise</option>
    </select>
  </div>
</header>

<nav class="ribbon">
  <button class="ribbon-btn active" onclick="nav('dashboard', event)"><i class="fa fa-chart-pie"></i> Dashboard</button>
  <div class="ribbon-sep"></div>
  <button class="ribbon-btn" onclick="nav('pos', event)"><i class="fa fa-cash-register"></i> Sale (POS)</button>
  <button class="ribbon-btn" onclick="nav('inventory', event)"><i class="fa fa-boxes"></i> Inventory</button>
  <button class="ribbon-btn" onclick="nav('purchase', event)"><i class="fa fa-cart-shopping"></i> Purchase</button>
  <div class="ribbon-sep"></div>
  <button class="ribbon-btn" onclick="nav('ledger', event)"><i class="fa fa-book"></i> Ledger</button>
  <button class="ribbon-btn" onclick="nav('expenses', event)"><i class="fa fa-receipt"></i> Expenses</button>
  <button class="ribbon-btn" onclick="nav('banking', event)"><i class="fa fa-university"></i> Banking</button>
  <button class="ribbon-btn" onclick="nav('hr', event)"><i class="fa fa-users"></i> Employees</button>
  <div class="ribbon-sep"></div>
  <button class="ribbon-btn" onclick="nav('settings', event)"><i class="fa fa-cogs"></i> Settings</button>
</nav>

<main class="main-area">
  <!-- DASHBOARD -->
  <div id="dashboard" class="view active">
    <div class="dash-grid">
      <div class="tile">
        <span class="tile-head">Total Sales (Today)</span>
        <span class="tile-val" id="d-total">0.00</span>
        <span class="tile-sub">Cash + Credit + Online</span>
      </div>
      <div class="tile">
        <span class="tile-head">Cash Sales</span>
        <span class="tile-val" id="d-cash">0.00</span>
      </div>
      <div class="tile">
        <span class="tile-head">Credit Sales / Outstanding</span>
        <span class="tile-val" id="d-credit" style="color:var(--warn)">0.00</span>
      </div>
      <div class="tile">
        <span class="tile-head">Online / Bank Sales</span>
        <span class="tile-val" id="d-online">0.00</span>
      </div>
      <div class="tile">
        <span class="tile-head">Gross Profit</span>
        <span class="tile-val" id="d-gross" style="color:var(--success)">0.00</span>
      </div>
      <div class="tile" style="border-color:var(--danger)">
        <span class="tile-head">Net Profit</span>
        <span class="tile-val text-danger" id="d-net">0.00</span>
      </div>
      <!-- Added: Misc Profit tile -->
      <div class="tile">
        <span class="tile-head">Misc Profit</span>
        <span class="tile-val" id="d-misc">0.00</span>
      </div>
    </div>

    <div class="report-bar">
      <h3 style="color:var(--muted); margin-bottom:10px; border-bottom:1px solid var(--border); padding-bottom:5px;">REPORTS & ACTIONS</h3>
      <div class="report-controls">
        <div class="field"><label>From</label><input type="date" id="rpt-start" style="width:140px"></div>
        <div class="field"><label>To</label><input type="date" id="rpt-end" style="width:140px"></div>

        <div class="field">
          <label>Sale</label>
          <div class="row">
            <button class="btn btn-sm" onclick="viewReport('sale')"><i class="fa fa-eye"></i> View</button>
            <button class="btn btn-sm" onclick="printReport('sale')"><i class="fa fa-print"></i> Print</button>
          </div>
        </div>

        <div class="field">
          <label>Profit</label>
          <div class="row">
            <button class="btn btn-sm" onclick="viewReport('profit')"><i class="fa fa-eye"></i> View</button>
            <button class="btn btn-sm" onclick="printReport('profit')"><i class="fa fa-print"></i> Print</button>
          </div>
        </div>

        <div class="field">
          <label>Expense</label>
          <div class="row">
            <button class="btn btn-sm" onclick="viewReport('expense')"><i class="fa fa-eye"></i> View</button>
            <button class="btn btn-sm" onclick="printReport('expense')"><i class="fa fa-print"></i> Print</button>
          </div>
        </div>

        <div class="field">
          <label>Stock</label>
          <div class="row">
            <button class="btn btn-sm" onclick="viewReport('stock')"><i class="fa fa-eye"></i> View</button>
            <button class="btn btn-sm" onclick="printReport('stock')"><i class="fa fa-print"></i> Print</button>
          </div>
        </div>

        <div style="flex:1"></div>

        <!-- BILL BROWSER -->
        <div class="field">
          <label>Browse Bills (by Invoice#)</label>
          <div class="row">
            <button class="btn btn-sm" onclick="billPrev()"><i class="fa fa-chevron-left"></i></button>
            <input id="bill-index" style="width:120px;text-align:center" readonly />
            <button class="btn btn-sm" onclick="billNext()"><i class="fa fa-chevron-right"></i></button>
          </div>
        </div>

        <div class="field">
          <label>&nbsp;</label>
          <div class="row">
            <button class="btn btn-sm" onclick="billPrintCurrent()"><i class="fa fa-print"></i> Reprint</button>
            <button class="btn btn-sm" onclick="billEditCurrent()"><i class="fa fa-pen"></i> Edit</button>
            <button class="btn btn-sm btn-danger" onclick="billReturnCurrent()"><i class="fa fa-undo"></i> Return</button>
          </div>
        </div>

        <!-- Added: Misc Profit control -->
        <div class="field">
          <label>Misc Profit</label>
          <div class="row">
            <button class="btn btn-sm" onclick="addMiscProfitPrompt()"><i class="fa fa-plus"></i> Add</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Note: Items quick view removed from dashboard per request -->
  </div>

  <!-- POS -->
  <div id="pos" class="view">
    <div class="pos-layout">
      <!-- left -->
      <div class="panel">
        <div class="field">
          <label>Customer</label>
          <div class="row">
            <select id="pos-cust"></select>
            <button class="btn btn-primary" onclick="modal('m-cust')">+</button>
          </div>
        </div>

        <div class="field"><label>Payment Mode</label>
          <select id="pos-mode" onchange="toggleBank('pos-mode','pos-bank-row')">
            <option value="Cash">Cash</option>
            <option value="Credit">Credit</option>
            <option value="Online">Online/Bank</option>
          </select>
        </div>

        <div class="field hidden" id="pos-bank-row" style="display:none">
          <label>Select Bank</label><select id="pos-bank"></select>
        </div>

        <div class="field"><label>Remarks</label><textarea id="pos-rem" rows="2"></textarea></div>

        <div style="margin-top:auto"></div>

        <div class="row">
          <button class="btn col" onclick="holdBill()">HOLD (F6)</button>
          <button class="btn col" onclick="recallBill()">RECALL (F7)</button>
        </div>
      </div>

      <!-- center -->
      <div class="panel">
        <div class="field">
          <label>Scan Barcode / Search Item</label>
          <input id="pos-search" placeholder="Type item name or code..." oninput="filterPosList()" />
        </div>

        <!-- Moved: Quick List under search bar with toggle -->
        <div class="table-container hidden" id="pos-quick-list" style="height:180px">
          <div class="table-scroll">
            <table>
              <thead><tr><th>Code</th><th>Name</th><th class="text-right">Stock</th><th class="text-right">Price</th><th></th></tr></thead>
              <tbody id="pos-items-body"></tbody>
            </table>
          </div>
        </div>

        <div class="table-container" style="height:180px">
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th>Code</th><th>Name</th><th class="text-right">Price</th><th class="text-right">Stock</th><th></th>
                </tr>
              </thead>
              <tbody id="pos-search-body"></tbody>
            </table>
          </div>
        </div>

        <div class="field">
          <label>Cart Items</label>
        </div>

        <div class="table-container" style="flex:1">
          <div class="table-scroll">
            <table id="pos-table">
              <thead><tr><th>Item</th><th>Unit</th><th>Qty</th><th class="text-right">Price</th><th class="text-right">Total</th><th></th></tr></thead>
              <tbody id="pos-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- right -->
      <div class="panel">
        <div class="field"><label>Date</label><input type="date" id="pos-date"></div>

        <div class="pos-totals">
          <div class="pos-row"><span>Subtotal</span><span id="pos-sub">0.00</span></div>
          <div class="pos-row"><span>Discount</span><input type="number" id="pos-disc" value="0" style="width:70px; text-align:right" oninput="calcPos()"></div>
          <div class="pos-row"><span>Tax (%)</span><input type="number" id="pos-tax" value="0" style="width:70px; text-align:right" oninput="calcPos()"></div>
          <div class="pos-row"><span>Fixed Tax</span><input type="number" id="pos-fixed-tax" value="0" style="width:70px; text-align:right" oninput="calcPos()"></div>
          <div class="pos-row"><span>Service Chg</span><input type="number" id="pos-svc" value="0" style="width:70px; text-align:right" oninput="calcPos()"></div>
          <div class="grand-total" id="pos-net">0.00</div>
        </div>

        <div class="field"><label>Tendered</label><input type="number" id="pos-tend" oninput="calcChange()"></div>
        <div class="pos-row" style="font-size:1.1rem; font-weight:bold"><span>Change:</span><span id="pos-change">0.00</span></div>

        <div class="pos-controls">
          <div style="display:flex; gap:8px; margin-top:10px">
            <button class="btn btn-primary" style="height:46px; flex:1" onclick="saveOrPrint('save')"><i class="fa fa-save"></i> Save Bill</button>
            <!-- per request: removed plain Print (No Save) option from POS -->
            <button class="btn btn-primary" style="height:46px; flex:1" onclick="saveOrPrint('saveprint')"><i class="fa fa-save"></i> Save & Print</button>
          </div>

          <button class="btn btn-danger btn-block" style="margin-top:8px;" onclick="clearPos()">CLEAR</button>
          <div style="height:6px"></div>

          <!-- quick browse saved/held bills while in POS -->
          <div style="display:flex; gap:8px; align-items:center;">
            <button class="btn btn-sm" onclick="billPrev()"><i class="fa fa-chevron-left"></i> Prev Bill</button>
            <button class="btn btn-sm" onclick="billNext()">Next Bill <i class="fa fa-chevron-right"></i></button>
            <div style="flex:1"></div>
            <button class="btn btn-sm" onclick="openBillBrowser()"><i class="fa fa-list"></i> Open Bill Viewer</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- INVENTORY -->
  <div id="inventory" class="view">
    <div class="row" style="margin-bottom:10px; justify-content:space-between">
      <input id="inv-search" placeholder="Search items..." style="width:300px" onkeyup="renderInv()">
      <button class="btn btn-primary" onclick="newItem()"><i class="fa fa-plus"></i> Add Item</button>
    </div>

    <div class="table-container"><div class="table-scroll">
      <table>
        <thead><tr><th>Code</th><th>Name</th><th>Loc</th><th class="text-right">Cost</th><th class="text-right">Price</th><th>Base Unit</th><th class="text-right">Stock</th><th>Action</th></tr></thead>
        <tbody id="inv-body"></tbody>
      </table>
    </div></div>
  </div>

  <!-- PURCHASE -->
  <div id="purchase" class="view">
    <div class="row" style="margin-bottom:10px;">
      <div class="panel col">
        <div class="field">
          <label>Supplier</label>
          <div class="row">
            <select id="pur-sup"></select>
            <button class="btn btn-primary" onclick="modal('m-sup')">+</button>
          </div>
        </div>
        <div class="field"><label>Date</label><input type="date" id="pur-date"></div>
      </div>

      <div class="panel col">
        <div class="field"><label>Search Item</label>
          <input id="pur-search" placeholder="Type name/code" oninput="filterPurchaseList()">
        </div>

        <div class="table-container">
          <div class="table-scroll">
            <table>
              <thead><tr><th>Code</th><th>Name</th><th class="text-right">Cost</th><th class="text-right">Stock</th><th></th></tr></thead>
              <tbody id="pur-search-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="field"><label>Purchase Items</label></div>
      <div class="table-container">
        <div class="table-scroll">
          <table>
            <thead><tr><th>Item</th><th>Qty</th><th class="text-right">Cost</th><th class="text-right">Total</th><th></th></tr></thead>
            <tbody id="pur-body"></tbody>
          </table>
        </div>
      </div>

      <div class="pos-row" style="margin-top:8px;"><span>Total</span><span id="pur-total">0.00</span></div>
      <button class="btn btn-primary" style="margin-top:8px;" onclick="savePurchase()"><i class="fa fa-save"></i> Save Purchase</button>
      <button class="btn" style="margin-top:8px;" onclick="printPurchaseReport()"><i class="fa fa-print"></i> Print Purchase Report</button>
    </div>
  </div>

  <!-- LEDGER -->
  <div id="ledger" class="view">
    <div class="row" style="height:100%; gap:20px;">
      <div class="panel col">
        <div class="row" style="align-items:center; border-bottom:1px solid var(--border); padding-bottom:5px;">
          <strong style="color:var(--accent-soft)">CUSTOMERS</strong>
          <input id="search-cust" placeholder="Search..." style="margin-left:auto; width:150px" onkeyup="renderLedgers()">
        </div>

        <!-- Customer Credit Report Controls -->
        <div style="margin-top:10px; margin-bottom:10px; display:flex; gap:8px; align-items:flex-end;">
          <div style="flex:1">
            <label class="small-muted">Customer (creditors)</label>
            <select id="led-credit-cust" style="width:100%"></select>
          </div>
          <div style="width:150px">
            <label class="small-muted">From</label>
            <input type="date" id="led-rpt-start">
          </div>
          <div style="width:150px">
            <label class="small-muted">To</label>
            <input type="date" id="led-rpt-end">
          </div>
          <div>
            <button class="btn btn-sm btn-primary" style="height:36px" onclick="printCustomerCreditReport()"><i class="fa fa-print"></i> Print Credit Report</button>
          </div>
        </div>

        <div class="table-container"><div class="table-scroll">
          <table><thead><tr><th>Name</th><th class="text-right">Balance</th><th>Act</th></tr></thead><tbody id="led-cust"></tbody></table>
        </div></div>
      </div>

      <div class="panel col">
        <div class="row" style="align-items:center; border-bottom:1px solid var(--border); padding-bottom:5px;">
          <strong style="color:var(--warn)">SUPPLIERS</strong>
          <input id="search-sup" placeholder="Search..." style="margin-left:auto; width:150px" onkeyup="renderLedgers()">
          <button class="btn btn-sm" onclick="modal('m-sup')">+</button>
        </div>

        <!-- Supplier Report Controls -->
        <div style="margin-top:10px; margin-bottom:10px; display:flex; gap:8px; align-items:flex-end;">
          <div style="flex:1">
            <label class="small-muted">Supplier</label>
            <select id="led-sup-select" style="width:100%"></select>
          </div>
          <div style="width:150px">
            <label class="small-muted">From</label>
            <input type="date" id="led-sup-start">
          </div>
          <div style="width:150px">
            <label class="small-muted">To</label>
            <input type="date" id="led-sup-end">
          </div>
          <div>
            <button class="btn btn-sm btn-primary" style="height:36px" onclick="printSupplierReport()"><i class="fa fa-print"></i> Print Supplier Report</button>
          </div>
        </div>

        <div class="table-container"><div class="table-scroll">
          <table><thead><tr><th>Name</th><th class="text-right">Payable</th><th>Act</th></tr></thead><tbody id="led-sup"></tbody></table>
        </div></div>
      </div>
    </div>
  </div>

  <!-- EXPENSES -->
  <div id="expenses" class="view">
    <div class="row" style="margin-bottom:10px; justify-content:space-between">
      <h3>Expense Tracker</h3>
      <button class="btn btn-primary" onclick="modal('m-exp')">Add Expense</button>
    </div>

    <div class="table-container"><div class="table-scroll">
      <table><thead><tr><th>Date</th><th>Category</th><th>Payee</th><th>Description</th><th class="text-right">Amount</th></tr></thead><tbody id="exp-body"></tbody></table>
    </div></div>
  </div>

  <!-- BANKING -->
  <div id="banking" class="view">
    <div class="row" style="margin-bottom:10px; justify-content:space-between">
      <h3>Banking & Accounts</h3>
      <button class="btn btn-primary" onclick="modal('m-bank')">Add Bank</button>
    </div>

    <div class="table-container"><div class="table-scroll">
      <table><thead><tr><th>Bank Name</th><th>Account No</th><th class="text-right">Balance</th></tr></thead><tbody id="bank-body"></tbody></table>
    </div></div>
  </div>

  <!-- HR / Employees -->
  <div id="hr" class="view">
    <div class="row" style="margin-bottom:10px; justify-content:space-between">
      <h3>Employees & Attendance</h3>
      <div style="display:flex; gap:8px;">
        <button class="btn btn-primary" onclick="modal('m-emp')">Add Employee</button>
        <button class="btn" onclick="modal('m-att')">Mark Attendance</button>
        <button class="btn" onclick="printAttendanceReport()">Attendance Report</button>
      </div>
    </div>

    <div class="panel">
      <div style="margin-bottom:8px; font-weight:700">Employee List</div>
      <div class="table-container" style="height:260px">
        <div class="table-scroll">
          <table><thead><tr><th>ID</th><th>Name</th><th>Role</th><th>Act</th></tr></thead><tbody id="emp-body"></tbody></table>
        </div>
      </div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="settings" class="view">
    <div class="row">
      <div class="panel col" style="max-width:600px">
        <h3>Company Info (For Bill)</h3>
        <div class="field"><label>Company Name</label><input id="set-name"></div>
        <div class="field"><label>Address / Phone</label><textarea id="set-addr" rows="3"></textarea></div>

        <!-- Changed: Logo upload (image), used ONLY on bill -->
        <div class="field"><label>Upload Logo (for Bill only)</label><input type="file" id="set-logo-file" accept="image/*"></div>

        <div class="field"><label>Default tax mode</label>
          <select id="set-tax-mode" onchange="toggleFixedTaxSettings()">
            <option value="percent">Percentage (per-bill %)</option>
            <option value="fixed">Fixed amount</option>
          </select>
        </div>

        <div id="fixed-tax-settings" class="field" style="display:none">
          <label>Fixed tax amount</label>
          <input type="number" id="set-fixed-tax" value="0">
        </div>

        <div class="field"><label>Default tax % (if percent mode)</label><input type="number" id="set-tax-percent" value="0"></div>

        <!-- Added: Toggle for Quick List in POS -->
        <div class="field"><label><input type="checkbox" id="toggleQuickList"> Show Quick List in POS</label></div>

        <button class="btn btn-primary" onclick="saveSettings()">Save Info</button>
      </div>

      <div class="panel col" style="max-width:300px; border-color:var(--danger)">
        <h3 class="text-danger">Danger Zone</h3>
        <p>This will wipe all sales, items, and accounts.</p>
        <button class="btn btn-danger" onclick="hardReset()">HARD RESET (Pass: 1234)</button>
      </div>
    </div>
  </div>
</main>
</div>

<!-- EXCEL STYLE SEARCH SOURCE -->
<datalist id="dl-items"></datalist>

<!-- ITEM MODAL -->
<div class="modal-overlay" id="m-item"><div class="modal">
  <div class="modal-head"><span id="mi-title">Item Details</span><button class="btn btn-danger" onclick="closeModal('m-item')">X</button></div>
  <input type="hidden" id="mi-id">
  <div class="row"><div class="field col"><label>Barcode</label><input id="mi-code"></div><div class="field col"><label>Name</label><input id="mi-name"></div></div>
  <div class="row"><div class="field col"><label>Cost</label><input type="number" id="mi-cost"></div><div class="field col"><label>Price (Base)</label><input type="number" id="mi-price"></div></div>
  <div class="row"><div class="field col"><label>Stock (Base)</label><input type="number" id="mi-stock"></div><div class="field col"><label>Low Alert</label><input type="number" id="mi-alert" value="5"></div></div>
  <div class="field"><label>Location/Shelf</label><input id="mi-loc"></div>
  <div style="border-top:1px solid var(--border); padding-top:5px; margin-top:5px;"><strong>Units & Conversion</strong></div>
  <div class="row">
    <div class="field col"><label>Base Unit (e.g. Pcs, g)</label><select id="mi-u1"></select></div>
    <div class="field col"><label>Alt Unit (optional)</label><select id="mi-u2"></select></div>
  </div>
  <div class="field"><label>How many base units in alt? (e.g. 1000 if base=g and alt=kg)</label><input type="number" id="mi-conv" value="1"></div>
  <button class="btn btn-primary" onclick="saveItem()">Save Item</button>
</div></div>

<!-- CUSTOMER / SUPPLIER / BANK / EXPENSE / PAYMENT MODALS -->
<div class="modal-overlay" id="m-cust"><div class="modal">
  <div class="modal-head"><span>New Customer</span><button class="btn btn-danger" onclick="closeModal('m-cust')">X</button></div>
  <div class="field"><label>Name</label><input id="mc-name"></div><div class="field"><label>Phone</label><input id="mc-phone"></div>
  <button class="btn btn-primary" onclick="saveContact('customers','mc')">Save</button>
</div></div>

<div class="modal-overlay" id="m-sup"><div class="modal">
  <div class="modal-head"><span>New Supplier</span><button class="btn btn-danger" onclick="closeModal('m-sup')">X</button></div>
  <div class="field"><label>Name</label><input id="ms-name"></div><div class="field"><label>Phone</label><input id="ms-phone"></div>
  <button class="btn btn-primary" onclick="saveContact('suppliers','ms')">Save</button>
</div></div>

<div class="modal-overlay" id="m-bank"><div class="modal">
  <div class="modal-head"><span>New Bank</span><button class="btn btn-danger" onclick="closeModal('m-bank')">X</button></div>
  <div class="field"><label>Bank Name</label><input id="mb-name"></div><div class="field"><label>Acct No</label><input id="mb-acc"></div><div class="field"><label>Opening Bal</label><input type="number" id="mb-bal"></div>
  <button class="btn btn-primary" onclick="saveBank()">Save</button>
</div></div>

<div class="modal-overlay" id="m-exp"><div class="modal">
  <div class="modal-head"><span>New Expense</span><button class="btn btn-danger" onclick="closeModal('m-exp')">X</button></div>
  <div class="field"><label>Category</label><select id="me-cat"><option>Food/Tea</option><option>Utilities</option><option>Rent</option><option>Wages</option><option>Other</option></select></div>
  <div class="field"><label>Payee (optional)</label><input id="me-payee"></div>
  <div class="field"><label>Description</label><input id="me-desc"></div><div class="field"><label>Amount</label><input type="number" id="me-amt"></div>
  <div class="field"><label>Assign to Employee (optional)</label><select id="me-emp"><option value="">-- none --</option></select></div>
  <button class="btn btn-primary" onclick="saveExp()">Save</button>
</div></div>

<div class="modal-overlay" id="m-pay"><div class="modal">
  <div class="modal-head"><span id="mp-title">Transaction</span><button class="btn btn-danger" onclick="closeModal('m-pay')">X</button></div>
  <input type="hidden" id="mp-id"><input type="hidden" id="mp-type">
  <h3 id="mp-name" style="text-align:center; color:var(--accent-soft)"></h3>
  <div class="field"><label>Amount</label><input type="number" id="mp-amt"></div>
  <div class="field"><label>Date</label><input type="date" id="mp-date"></div>
  <button class="btn btn-primary" onclick="processPayment()">Confirm & Print</button>
</div></div>

<!-- EMPLOYEE MODALS -->
<div class="modal-overlay" id="m-emp"><div class="modal">
  <div class="modal-head"><span>New Employee</span><button class="btn btn-danger" onclick="closeModal('m-emp')">X</button></div>
  <div class="field"><label>Employee ID</label><input id="me-id"></div>
  <div class="field"><label>Name</label><input id="me-name"></div>
  <div class="field"><label>Role</label><input id="me-role"></div>
  <button class="btn btn-primary" onclick="saveEmployee()">Save Employee</button>
</div></div>

<div class="modal-overlay" id="m-att"><div class="modal">
  <div class="modal-head"><span>Mark Attendance</span><button class="btn btn-danger" onclick="closeModal('m-att')">X</button></div>
  <div class="field"><label>Date</label><input type="date" id="att-date"></div>
  <div class="field"><label>Employee</label><select id="att-emp"></select></div>
  <div class="field"><label>Status</label><select id="att-status"><option>Present</option><option>Absent</option><option>Leave</option></select></div>
  <div class="field"><label>Shift / Note</label><input id="att-shift"></div>
  <button class="btn btn-primary" onclick="saveAttendance()">Save Attendance</button>
</div></div>

<!-- BILL VIEW / RETURN MODAL -->
<div class="modal-overlay" id="m-bill-view"><div class="modal" style="max-width:800px">
  <div class="modal-head"><span>Bill Viewer</span><button class="btn btn-danger" onclick="closeBillViewer()">X</button></div>
  <div id="bv-body" style="max-height:60vh; overflow:auto"></div>
  <div style="display:flex; gap:8px; justify-content:flex-end;">
    <button class="btn" onclick="closeBillViewer()">Close</button>
    <button class="btn btn-primary" onclick="billPrintCurrent()"><i class="fa fa-print"></i> Print</button>
    <button class="btn btn-primary" onclick="billEditCurrent()"><i class="fa fa-pen"></i> Edit</button>
    <button class="btn btn-danger" onclick="executeReturnFromViewer()"><i class="fa fa-undo"></i> Process Return</button>
  </div>
</div></div>

<div id="print-zone"></div>

<script>
/* DATA MODEL */
const DB_KEY = 'swan_erp_final_v2';

let db = {
  info: { name: "Company Name", addr: "Address Here", logo: "" },
  items: [],
  customers: [{id:1, name:"Walk-in", phone:"", bal:0}],
  suppliers: [],
  sales: [],
  expenses: [],
  banks: [],
  heldBills: [],
  transactions: [], // payments, purchases, sale pointers
  employees: [],
  attendance: [],
  miscProfits: [] // new: store misc profit entries {id,date,desc,amt}
};

let cart = [];
let purCart = [];
let currentBillIndex = -1; // index into combined bills list (held first, then saved)
let editingSaleId = null;

/* UNITS OPTIONS */
const UNIT_OPTIONS = ['Pcs','g','kg','lb','m','cm','inch','yard','litre','ml'];

/* INIT */
window.onload = () => {
  if(localStorage.getItem(DB_KEY)) {
    try { db = JSON.parse(localStorage.getItem(DB_KEY)); } catch(e){ console.error('db parse', e); }
  }
  setInterval(()=>document.getElementById('clock').innerText=new Date().toLocaleTimeString(),1000);

  const today = new Date().toISOString().split('T')[0];
  ['pos-date','rpt-start','rpt-end','mp-date','pur-date','led-rpt-start','led-rpt-end','led-sup-start','led-sup-end','att-date','led-rpt-start'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value=today;
  });

  // initialize unit selects
  const u1 = document.getElementById('mi-u1'), u2 = document.getElementById('mi-u2');
  UNIT_OPTIONS.forEach(u => { u1.innerHTML += `<option>${u}</option>`; u2.innerHTML += `<option>${u}</option>`; });

  // Quick List toggle initial
  const qlToggle = document.getElementById('toggleQuickList');
  if(qlToggle){
    const storedQL = localStorage.getItem('posQuickList') === 'true';
    qlToggle.checked = storedQL;
    document.getElementById('pos-quick-list').classList.toggle('hidden', !storedQL);
    qlToggle.addEventListener('change', (e)=>{
      const show = e.target.checked;
      localStorage.setItem('posQuickList', show ? 'true' : 'false');
      document.getElementById('pos-quick-list').classList.toggle('hidden', !show);
    });
  }

  // bill logo from localStorage (file upload), used only in bill HTML
  const storedBillLogo = localStorage.getItem('billLogo');
  if(storedBillLogo){ db.info.logo = storedBillLogo; }

  updateUI();
};

/* SAVE DB helper */
function saveDB(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); updateUI(); }

/* NAV */
function nav(id, ev){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  const el = document.getElementById(id);
  if(el) el.classList.add('active');
  document.querySelectorAll('.ribbon-btn').forEach(b=>b.classList.remove('active'));
  if(ev && ev.currentTarget) ev.currentTarget.classList.add('active');
  if(id==='dashboard') calcDash();
}

/* UTILITY */
function modal(id){ document.getElementById(id).style.display='flex'; }
function closeModal(id){ document.getElementById(id).style.display='none'; }
function setTheme(t){ document.body.className = t || 'theme-default'; }
function toggleBank(src,tgt){ document.getElementById(tgt).style.display = document.getElementById(src).value==='Online'?'block':'none'; }
function num(id){ return parseFloat(document.getElementById(id).value)||0; }
function val(id){ return document.getElementById(id).value; }
function formatCurrency(v){ return (parseFloat(v)||0).toFixed(2); }

/* UI RENDER */
function updateUI(){
  // populate customers
  const pc = document.getElementById('pos-cust');
  const lc = document.getElementById('led-credit-cust');
  pc.innerHTML = ''; lc.innerHTML = '';
  db.customers.forEach(c=>{ pc.innerHTML += `<option value="${c.id}">${c.name}</option>`; lc.innerHTML += `<option value="${c.id}">${c.name}</option>`; });

  // banks
  const pb = document.getElementById('pos-bank');
  pb.innerHTML = '<option value="">-- select --</option>';
  db.banks.forEach(b=> pb.innerHTML += `<option>${b.name}</option>`);

  // inventory list (inventory view)
  const invBody = document.getElementById('inv-body');
  if(invBody){
    const q = (document.getElementById('inv-search')||{value:''}).value.toLowerCase();
    invBody.innerHTML = db.items.filter(i=> (i.name||'').toLowerCase().includes(q) || (i.code||'').toLowerCase().includes(q) ).map(i=>{
      return `<tr>
        <td>${i.code||''}</td><td>${i.name}</td><td>${i.loc||'-'}</td><td class="text-right">${(i.cost||0).toFixed(2)}</td><td class="text-right">${(i.price||0).toFixed(2)}</td><td>${i.u1||'Pcs'}</td><td class="text-right">${(i.stock||0).toFixed(2)}</td>
        <td><button class="btn btn-sm" onclick="editItem(${i.id})">Edit</button></td>
      </tr>`;
    }).join('');
  }

  // POS: Quick List moved under search bar
  const posItems = document.getElementById('pos-items-body');
  if(posItems){
    posItems.innerHTML = db.items.map(i=>`<tr>
      <td>${i.code||''}</td>
      <td>${i.name}</td>
      <td class="text-right">${(i.stock||0).toFixed(2)}</td>
      <td class="text-right">${(i.price||0).toFixed(2)}</td>
      <td><button class="btn btn-sm" onclick="addItemToCart(${i.id})">Add</button></td>
    </tr>`).join('');
  }

  // ledger lists (exclude Walk-in)
  const ledCust = document.getElementById('led-cust');
  ledCust.innerHTML = db.customers
    .filter(c => (c.name||'').trim().toLowerCase() !== 'walk-in')
    .map(c=>`<tr><td>${c.name}</td><td class="text-right">${(c.bal||0).toFixed(2)}</td><td><button class="btn btn-sm" onclick="openCust(${c.id})">Open</button></td></tr>`).join('');

  const ledSup = document.getElementById('led-sup');
  ledSup.innerHTML = db.suppliers.map(s=>`<tr><td>${s.name}</td><td class="text-right">${(s.payable||0).toFixed(2)}</td><td><button class="btn btn-sm" onclick="openSup(${s.id})">Open</button></td></tr>`).join('');

  // employees list
  const empBody = document.getElementById('emp-body');
  if(empBody) empBody.innerHTML = db.employees.map(e=>`<tr><td>${e.id}</td><td>${e.name}</td><td>${e.role}</td><td><button class="btn btn-sm" onclick="editEmployee('${e.id}')">Edit</button></td></tr>`).join('');

  // expenses
  const expBody = document.getElementById('exp-body');
  if(expBody) expBody.innerHTML = db.expenses.map(e=>`<tr><td>${e.date}</td><td>${e.cat}</td><td>${e.payee||'-'}</td><td>${e.desc||''}</td><td class="text-right">${(e.amt||0).toFixed(2)}</td></tr>`).join('');

  // banks list
  const bankBody = document.getElementById('bank-body');
  if(bankBody) bankBody.innerHTML = db.banks.map(b=>`<tr><td>${b.name}</td><td>${b.acc}</td><td class="text-right">${(b.bal||0).toFixed(2)}</td></tr>`).join('');

  // dashboard tiles
  calcDash();
}

/* DASHBOARD */
function calcDash(){
  const today=new Date().toISOString().split('T')[0];
  let s=0,c=0,cr=0,online=0,gross=0,net=0,e=0;

  db.sales.filter(x=>x.date===today).forEach(x=>{
    s+=x.net;
    if(x.mode==='Cash') c+=x.net;
    if(x.mode==='Credit') cr+=x.net;
    if(x.mode==='Online') online+=x.net;

    // compute cost for each sale items
    let saleCost = 0;
    (x.items||[]).forEach(it=>{
      const item = db.items.find(i=>i.id==it.id) || {};
      const qty = it.unit==='alt' ? (it.qty * (it.conv||1)) : it.qty;
      saleCost += (item.cost||it.cost||0) * qty;
    });
    const saleGross = (x.sub - saleCost);
    gross += saleGross;
    net += saleGross - (x.disc||0);
  });

  db.expenses.filter(x=>x.date===today).forEach(x=>e+=x.amt);

  // add misc profits for the day
  let miscToday = db.miscProfits.filter(m=>m.date===today).reduce((a,b)=>a+b.amt,0);
  net += miscToday;

  document.getElementById('d-total').innerText=s.toFixed(2);
  document.getElementById('d-cash').innerText=c.toFixed(2);
  document.getElementById('d-credit').innerText=cr.toFixed(2);
  document.getElementById('d-online').innerText=online.toFixed(2);
  document.getElementById('d-gross').innerText=gross.toFixed(2);
  document.getElementById('d-net').innerText=(net - e).toFixed(2);
  // update misc tile
  const miscEl = document.getElementById('d-misc'); if(miscEl) miscEl.innerText = (miscToday).toFixed(2);
}

/* REPORTS */
function buildReportHeader(){
  const logoHTML = db.info.logo ? `<img src="${db.info.logo}" alt="logo">` : '';
  const addrHTML = db.info.addr ? `<p style="margin:6px 0">${db.info.addr.replace('\n','<br>')}</p>` : '';
  return `<div class="print-header">${logoHTML}<h2>${db.info.name}</h2>${addrHTML}</div>`;
}

function buildReportHTML(type,d1,d2){
  let h=buildReportHeader();
  h+=`<h3 style="text-align:center; margin-bottom:6px">${type.toUpperCase()} REPORT</h3>`;
  h+=`<p style="text-align:center">${d1} to ${d2}</p>`;
  h+=`<table class="print-table" style="width:100%; border-collapse:collapse; font-size:12px;"><thead>`;

  if(type==='sale'){
    h+=`<tr><th>Date</th><th>Inv#</th><th>Customer</th><th>Mode</th><th style="text-align:right">Amount</th></tr></thead><tbody>`;
    let tot=0;
    db.sales.filter(s=>s.date>=d1 && s.date<=d2).forEach(s=>{
      const c=db.customers.find(c=>c.id==s.custId);
      h+=`<tr><td>${s.date}</td><td>${s.id}</td><td>${c?c.name:'-'}</td><td>${s.mode}</td><td style="text-align:right">${s.net.toFixed(2)}</td></tr>`;
      tot+=s.net;
    });
    h+=`</tbody></table><h3 style="text-align:right">Total: ${tot.toFixed(2)}</h3>`;
  } else if(type==='stock'){
    h+=`<tr><th>Item</th><th>Loc</th><th>Stock</th><th style="text-align:right">Cost</th><th style="text-align:right">Value</th></tr></thead><tbody>`;
    let tv=0;
    db.items.forEach(i=>{
      const v=(i.stock||0)*(i.cost||0); tv+=v;
      h+=`<tr><td>${i.name}</td><td>${i.loc||'-'}</td><td>${i.stock}</td><td style="text-align:right">${(i.cost||0).toFixed(2)}</td><td style="text-align:right">${v.toFixed(2)}</td></tr>`;
    });
    h+=`</tbody></table><h3 style="text-align:right">Total Val: ${tv.toFixed(2)}</h3>`;
  } else if(type==='expense'){
    h+=`<tr><th>Date</th><th>Cat</th><th>Payee</th><th>Desc</th><th style="text-align:right">Amt</th></tr></thead><tbody>`;
    let te=0;
    db.expenses.filter(e=>e.date>=d1 && e.date<=d2).forEach(e=>{
      h+=`<tr><td>${e.date}</td><td>${e.cat}</td><td>${e.payee||'-'}</td><td>${e.desc}</td><td style="text-align:right">${e.amt.toFixed(2)}</td></tr>`;
      te+=e.amt;
    });
    h+=`</tbody></table><h3 style="text-align:right">Total Exp: ${te.toFixed(2)}</h3>`;
  } else if(type==='profit'){
    // compute gross and net for the period
    let gross=0, totalCost=0, totalSales=0;
    db.sales.filter(s=>s.date>=d1 && s.date<=d2).forEach(s=>{
      totalSales += s.net;
      let saleCost = 0;
      (s.items||[]).forEach(it=>{
        const item = db.items.find(i=>i.id==it.id) || {};
        const qty = it.unit==='alt' ? (it.qty * (it.conv||1)) : it.qty;
        saleCost += (item.cost||it.cost||0) * qty;
      });
      totalCost += saleCost;
      gross += (s.sub - saleCost);
    });
    const totalExp = db.expenses.filter(e=>e.date>=d1 && e.date<=d2).reduce((a,b)=>a+b.amt,0);
    const misc = db.miscProfits.filter(m=>m.date>=d1 && m.date<=d2).reduce((a,b)=>a+b.amt,0);
    const netProfit = gross - totalExp + misc;

    h+=`</thead><tbody>`;
    h+=`<tr><td><strong>Sales Total</strong></td><td style="text-align:right">${totalSales.toFixed(2)}</td></tr>`;
    h+=`<tr><td><strong>Cost of Goods Sold</strong></td><td style="text-align:right">${totalCost.toFixed(2)}</td></tr>`;
    h+=`<tr><td><strong>Gross Profit</strong></td><td style="text-align:right">${gross.toFixed(2)}</td></tr>`;
    h+=`<tr><td><strong>Expenses</strong></td><td style="text-align:right">${totalExp.toFixed(2)}</td></tr>`;
    h+=`<tr><td><strong>Misc Profit</strong></td><td style="text-align:right">${misc.toFixed(2)}</td></tr>`;
    h+=`<tr><td><strong>Net Profit</strong></td><td style="text-align:right">${netProfit.toFixed(2)}</td></tr>`;
    h+=`</tbody></table>`;
  } else {
    h+=`<tr><th>Data</th></tr></thead><tbody><tr><td>No data</td></tr></tbody></table>`;
  }

  // wrap with full HTML and a print-friendly style
  return `<!doctype html><html><head><meta charset="utf-8"><title>${type} report</title>
  <style>
  body{font-family:Arial,Helvetica,sans-serif;color:#000;margin:12px}
  .print-header img{max-height:60px; display:block; margin:0 auto 6px}
  table.print-table{width:100%; border-collapse:collapse}
  table.print-table th, table.print-table td{border:1px solid #ddd; padding:6px; text-align:left}
  h2,h3{margin:4px 0}
  </style></head><body>${h}</body></html>`;
}

function viewReport(type){
  const d1=val('rpt-start') || '1900-01-01', d2=val('rpt-end') || new Date().toISOString().split('T')[0];
  const html=buildReportHTML(type,d1,d2);
  const w=window.open('','_blank');
  w.document.write(html);
  w.document.close();
}

function printReport(type){
  const d1=val('rpt-start') || '1900-01-01', d2=val('rpt-end') || new Date().toISOString().split('T')[0];
  const html=buildReportHTML(type,d1,d2);
  const w=window.open('','_blank');
  w.document.write(html);
  w.document.close();
  // ensure print after load
  w.onload = ()=>{ w.print(); setTimeout(()=>w.close(), 500); };
}

/* POS SEARCH (barcode auto-add vs name show) */
function filterPosList(){
  const qRaw=val('pos-search')||'';
  const q=qRaw.trim().toLowerCase();
  const body=document.getElementById('pos-search-body');
  if(!q){ body.innerHTML=''; return; }

  // barcode exact-match (code)
  const byCode = db.items.find(i => (i.code||'').toLowerCase() === q);
  if(byCode){
    addItemToCart(byCode.id);
    document.getElementById('pos-search').value='';
    body.innerHTML='';
    return;
  }

  // name or partial match (show only)
  const matches = db.items.filter(i => ( (i.name||'') + ' ' + (i.code||'') ).toLowerCase().includes(q) ).slice(0,200);
  body.innerHTML = matches.map(i=>`
  <tr>
    <td>${i.code||''}</td>
    <td>${i.name}</td>
    <td class="text-right">${(i.price||0).toFixed(2)}</td>
    <td class="text-right">${i.stock||0}</td>
    <td><button class="btn btn-sm" onclick="addItemToCart(${i.id})">Add</button></td>
  </tr>`).join('');
}

/* CART & UNITS */
function addItemToCart(id){
  const i=db.items.find(x=>x.id==id); if(!i) return;
  const ex=cart.find(c=>c.id==i.id && c.unit==='base');

  // if item exists in cart, increment its qty; else add new row
  if(ex) ex.qty = (parseFloat(ex.qty)||0) + 1;
  else cart.push({
    id:i.id,name:i.name,qty:1,price:parseFloat(i.price||0),cost:parseFloat(i.cost||0),
    unit:'base',basePrice:parseFloat(i.price||0),baseCost:parseFloat(i.cost||0),conv:i.conv||1,u1:i.u1||'Pcs',u2:i.u2||'', loc: i.loc
  });
  renderCart();
}

function setUnit(idx,mode){
  const c=cart[idx];
  if(mode==='alt'){c.unit='alt';c.price=c.basePrice*c.conv;}
  else{c.unit='base';c.price=c.basePrice;}
  renderCart();
}

function updateCartPrice(idx,val){ cart[idx].price=parseFloat(val)||0; renderCart(); }

function renderCart(){
  const tb=document.getElementById('pos-body');tb.innerHTML='';
  let sub=0;
  cart.forEach((c,idx)=>{
    const unitSelect=c.u2? `
    <select style="width:60px;padding:0;font-size:0.75rem" onchange="setUnit(${idx},this.value)">
      <option value="base" ${c.unit==='base'?'selected':''}>${c.u1}</option>
      <option value="alt" ${c.unit==='alt'?'selected':''}>${c.u2}</option>
    </select>` : c.u1;

    const total = (parseFloat(c.qty)||0) * (parseFloat(c.price)||0);
    sub+=total;

    tb.innerHTML+=`
    <tr>
      <td>
        <div style="font-weight:600">${c.name}</div>
        <div class="small-muted">Loc: ${c.loc||'-'}</div>
      </td>
      <td>${unitSelect}</td>
      <td><input type="number" value="${c.qty}" style="width:50px" oninput="cart[${idx}].qty=parseFloat(this.value)||0;renderCart()"></td>
      <td class="text-right"><input type="number" value="${(parseFloat(c.price)||0).toFixed(2)}" style="width:80px;text-align:right" oninput="updateCartPrice(${idx},this.value)"></td>
      <td class="text-right">${total.toFixed(2)}</td>
      <td><i class="fa fa-times text-danger" style="cursor:pointer" onclick="cart.splice(${idx},1);renderCart()"></i></td>
    </tr>`;
  });
  document.getElementById('pos-sub').innerText=sub.toFixed(2);
  calcPos();
}

/* TAX & CALC */
function calcPos(){
  const sub=parseFloat(document.getElementById('pos-sub').innerText)||0;
  const disc=num('pos-disc');
  const taxP = document.getElementById('set-tax-mode').value === 'percent' ? (num('pos-tax') || num('set-tax-percent')) : 0;
  const fixedTaxEnabled = document.getElementById('set-tax-mode').value === 'fixed';
  const fixedTaxSys = num('set-fixed-tax') || 0;
  const svc=num('pos-svc') || 0;
  const fixedTaxField = num('pos-fixed-tax') || 0;
  const tax = fixedTaxEnabled ? (fixedTaxSys + fixedTaxField) : ((sub - disc) * (taxP/100));
  const net = (sub - disc) + tax + svc;
  document.getElementById('pos-net').innerText = net.toFixed(2);
  calcChange();
}

function calcChange(){
  const net=parseFloat(document.getElementById('pos-net').innerText)||0;
  const tend=num('pos-tend');
  document.getElementById('pos-change').innerText=(tend-net).toFixed(2);
}

function clearPos(){
  cart=[];renderCart();
  ['pos-disc','pos-tax','pos-fixed-tax','pos-svc','pos-tend'].forEach(i=>{ const el=document.getElementById(i); if(el) el.value=0; });
  editingSaleId = null;
}

/* HOLD / RECALL */
function holdBill(){
  if(cart.length){
    const held = { id: 'H-' + Date.now(), cart: JSON.parse(JSON.stringify(cart)), d:num('pos-disc'), t:num('pos-tax'), s:num('pos-svc'), date: val('pos-date') || new Date().toISOString().split('T')[0] };
    db.heldBills.push(held);
    clearPos(); alert("Bill held"); saveDB();
  }
}

function recallBill(){
  if(!db.heldBills.length){alert("No held bills");return;}
  const b=db.heldBills.pop();
  cart=b.cart;document.getElementById('pos-disc').value=b.d;document.getElementById('pos-tax').value=b.t;document.getElementById('pos-svc').value=b.s;
  renderCart();saveDB();
}

/* SALE SAVE / PRINT / EDIT FLOW */
function saveOrPrint(mode){ // mode = 'save' | 'saveprint'
  if(!cart.length){ alert('Cart empty'); return; }

  if(editingSaleId){
    // if editing, revert previous sale first (restore stock & balances & remove transactions)
    revertSale(editingSaleId);
    editingSaleId = null;
  }

  const sub=parseFloat(document.getElementById('pos-sub').innerText)||0;
  const disc=num('pos-disc');
  const taxField = num('pos-fixed-tax') || 0;
  const useFixedSystem = document.getElementById('set-tax-mode').value === 'fixed';
  const taxPercent = num('pos-tax') || num('set-tax-percent') || 0;
  const tax = useFixedSystem ? (num('set-fixed-tax') + taxField) : ((sub - disc) * (taxPercent/100));
  const svc=num('pos-svc') || 0;
  const net = (sub - disc) + tax + svc;

  const custId=parseInt(val('pos-cust'))||1;
  const modePay=val('pos-mode');

  // Saving changes stocks & balances
  if(mode === 'save' || mode === 'saveprint'){
    if(modePay==='Credit' && custId===1){ alert("Credit only allowed to saved customers."); return; }

    let cost=0; let low=[];
    cart.forEach(c=>{
      const item=db.items.find(i=>i.id==c.id);
      if(!item){ return; }
      const deduct = c.unit === 'alt' ? (c.qty * (c.conv || 1)) : c.qty;
      item.stock = (parseFloat(item.stock)||0) - deduct;
      cost += deduct * (parseFloat(item.cost)||0);
      if(item.stock <= (item.alert||0)) low.push(item.name);
    });

    const sale = {
      id: Date.now(),
      date: val('pos-date') || new Date().toISOString().split('T')[0],
      custId,
      items: JSON.parse(JSON.stringify(cart)),
      sub, disc,
      tax, svc,
      net,
      profit: ( (sub - disc) - cost ), // gross profit for this sale (simple)
      mode: modePay
    };

    db.sales.push(sale);

    if(modePay === 'Credit'){
      const c = db.customers.find(x=>x.id==custId); if(c) c.bal = (parseFloat(c.bal)||0) + net;
      db.transactions.push({type:'sale', date: sale.date, party:'cust', partyId: custId, saleId: sale.id, amt: sale.net, items: sale.items});
    } else if(modePay === 'Online'){
      const b=db.banks.find(x=>x.name==val('pos-bank')); if(b) b.bal = (parseFloat(b.bal)||0) + net;
    }

    saveDB();

    if(low.length) alert("Low stock: "+low.join(", "));
    if(mode === 'save') { clearPos(); alert('Bill saved.'); return; }
    if(mode === 'saveprint'){ printBill(sale); clearPos(); return; }
  }
}

/* revert existing sale: restore stock, balances, transactions */
function revertSale(saleId){
  const idx = db.sales.findIndex(s=>s.id===saleId);
  if(idx === -1) return;
  const s = db.sales[idx];

  // restore stock
  s.items.forEach(i=>{
    const item = db.items.find(it=>it.id==i.id);
    if(item){
      const qty = i.unit === 'alt' ? (i.qty * (i.conv || 1)) : i.qty;
      item.stock = (parseFloat(item.stock)||0) + qty;
    }
  });

  // adjust customer/bank
  if(s.mode === 'Credit'){
    const c = db.customers.find(x=>x.id==s.custId); if(c) c.bal = (parseFloat(c.bal)||0) - s.net;
  } else if(s.mode === 'Online'){
    // best-effort: try to find a bank with transaction reference (not robust)
  }

  // remove transaction records related to this sale
  db.transactions = db.transactions.filter(t => !(t.type==='sale' && t.saleId === s.id));
  // remove the sale entry
  db.sales.splice(idx,1);
  saveDB();
}

/* PRINTING BILLS */
/* Robust printing: always open a new window and print from it to avoid DOM/overflow issues */
function printBill(s, isPreview=false){
  const c=db.customers.find(x=>x.id==s.custId)||{name:'Walk-in'};
  let productsHtml = '';
  s.items.forEach(i=>{
    productsHtml += `<tr>
      <td style="padding:6px">${i.name}${i.loc?`<div style="font-size:12px;color:#666">Loc: ${i.loc}</div>`:''}</td>
      <td style="padding:6px; text-align:center">${i.qty} ${i.unit==='alt'?i.u2:i.u1}</td>
      <td style="padding:6px; text-align:right">${(i.price||0).toFixed(2)}</td>
      <td style="padding:6px; text-align:right">${((i.price||0) * (i.qty||0)).toFixed(2)}</td>
    </tr>`;
  });

  const headerLogo = db.info.logo ? `<img src="${db.info.logo}" style="max-height:80px; display:block; margin:0 auto 6px">` : '';
  const html = `<!doctype html><html><head><meta charset="utf-8"><title>Invoice ${s.id}</title>
  <style>
  body{font-family:Arial,Helvetica,sans-serif;color:#000;margin:12px}
  .header{text-align:center}
  table{width:100%; border-collapse:collapse; margin-top:8px}
  th,td{border:1px solid #ddd;padding:6px;text-align:left}
  th{background:#f4f4f4}
  .right{text-align:right}
  </style></head><body>
  <div class="header">${headerLogo}<h2>${db.info.name}</h2><div style="margin-bottom:4px">${(db.info.addr||'')}</div></div>
  <div><strong>Inv:</strong> ${s.id} <strong style="margin-left:12px">Date:</strong> ${s.date} <strong style="margin-left:12px">Cust:</strong> ${c.name}</div>
  <table><thead><tr><th>Item</th><th style="text-align:center">Qty</th><th style="text-align:right">Price</th><th style="text-align:right">Total</th></tr></thead><tbody>
  ${productsHtml}
  </tbody></table>
  <div style="text-align:right;margin-top:10px;font-weight:bold">
    <p>Subtotal: ${ (s.sub||0).toFixed(2) }</p>
    ${(s.disc>0)?`<p>Disc: -${(s.disc||0).toFixed(2)}</p>`:''}
    ${(s.tax>0)?`<p>Tax: ${(s.tax||0).toFixed(2)}</p>`:''}
    ${(s.svc>0)?`<p>Svc: ${(s.svc||0).toFixed(2)}</p>`:''}
    <h3>NET TOTAL: ${(s.net||0).toFixed(2)}</h3>
  </div>
  </body></html>`;

  const w = window.open('','_blank');
  w.document.write(html);
  w.document.close();
  w.onload = ()=>{ w.print(); setTimeout(()=>w.close(),500); };
}

/* BILL BROWSING / VIEWER / RETURN */
function combinedBills(){
  // map held bills into consistent shape
  const held = (db.heldBills||[]).map(h=>({ kind:'held', id:h.id || ('H-'+(h.date||'')+Date.now()), date:h.date, data:h }));
  const saved = (db.sales||[]).map(s=>({ kind:'sale', id:s.id, date:s.date, data:s }));
  return held.concat(saved);
}

function updateBillIndexDisplay(){
  const list = combinedBills();
  if(list.length===0){ document.getElementById('bill-index').value = 'No bills'; currentBillIndex = -1; return; }
  if(currentBillIndex < 0) currentBillIndex = list.length-1; // default to last
  if(currentBillIndex >= list.length) currentBillIndex = 0;
  const cur = list[currentBillIndex];
  document.getElementById('bill-index').value = `${currentBillIndex+1}/${list.length} - ${cur.kind.toUpperCase()} #${cur.id}`;

  // also populate viewer body if open
  const bv = document.getElementById('bv-body');
  if(bv && cur){
    const s = cur.data;
    if(cur.kind === 'sale'){
      let itemsHtml = (s.items||[]).map(it=>`<tr><td>${it.name}</td><td style="text-align:center">${it.qty} ${it.unit==='alt'?it.u2:it.u1}</td><td style="text-align:right">${(it.price||0).toFixed(2)}</td><td style="text-align:right">${((it.price||0)*(it.qty||0)).toFixed(2)}</td></tr>`).join('');
      bv.innerHTML = `<div><strong>Invoice:</strong> ${s.id} &nbsp; <strong>Date:</strong> ${s.date} &nbsp; <strong>Mode:</strong> ${s.mode}</div>
      <table style="width:100%; border-collapse:collapse; margin-top:8px"><thead><tr><th>Item</th><th style="text-align:center">Qty</th><th style="text-align:right">Price</th><th style="text-align:right">Total</th></tr></thead><tbody>${itemsHtml}</tbody></table>
      <div style="text-align:right;margin-top:8px"><b>Net:</b> ${ (s.net||0).toFixed(2) }</div>`;
    } else {
      // held bill
      let itemsHtml = (s.cart||[]).map(it=>`<tr><td>${it.name}</td><td style="text-align:center">${it.qty} ${it.unit==='alt'?it.u2:it.u1}</td><td style="text-align:right">${(it.price||0).toFixed(2)}</td><td style="text-align:right">${((it.price||0)*(it.qty||0)).toFixed(2)}</td></tr>`).join('');
      const estimatedNet = (s.cart||[]).reduce((a,b)=>a + ((b.qty||0)*(b.price||0)),0) - (s.d||0) + (s.s||0) + (s.t||0);
      bv.innerHTML = `<div><strong>Held Bill:</strong> ${s.id || ''} &nbsp; <strong>Date:</strong> ${s.date || ''}</div>
      <table style="width:100%; border-collapse:collapse; margin-top:8px"><thead><tr><th>Item</th><th style="text-align:center">Qty</th><th style="text-align:right">Price</th><th style="text-align:right">Total</th></tr></thead><tbody>${itemsHtml}</tbody></table>
      <div style="text-align:right;margin-top:8px"><b>Estimate Net:</b> ${estimatedNet.toFixed(2)}</div>`;
    }
  }
}

function billPrev(){
  const list = combinedBills();
  if(list.length===0){ alert('No bills'); return; }
  currentBillIndex = (currentBillIndex <= 0) ? list.length-1 : currentBillIndex - 1;
  updateBillIndexDisplay();
  modal('m-bill-view');
}

function billNext(){
  const list = combinedBills();
  if(list.length===0){ alert('No bills'); return; }
  currentBillIndex = (currentBillIndex >= list.length-1) ? 0 : currentBillIndex + 1;
  updateBillIndexDisplay();
  modal('m-bill-view');
}

function openBillBrowser(){
  updateBillIndexDisplay();
  modal('m-bill-view');
}

function closeBillViewer(){
  closeModal('m-bill-view');
}

/* Print current displayed bill (from combined list) */
function billPrintCurrent(){
  const list = combinedBills();
  if(currentBillIndex<0 || currentBillIndex>=list.length){ alert('No bill selected'); return; }
  const cur = list[currentBillIndex];
  if(cur.kind === 'sale'){
    printBill(cur.data);
  } else {
    // held bill: print preview of held items
    const held = cur.data;
    const preview = {
      id: held.id || 'HOLD',
      date: held.date || new Date().toISOString().split('T')[0],
      custId: 1,
      items: held.cart||[],
      sub: (held.cart||[]).reduce((a,b)=>a + (b.qty||0)*(b.price||0),0),
      disc: held.d||0, tax: held.t||0, svc: held.s||0,
      net: ( (held.cart||[]).reduce((a,b)=>a + (b.qty||0)*(b.price||0),0) - (held.d||0) + (held.t||0) + (held.s||0) )
    };
    printBill(preview, true);
  }
}

/* Edit current bill: if it's a held bill, recall into cart. If saved sale, load for editing (reverts sale on save) */
function billEditCurrent(){
  const list = combinedBills();
  if(currentBillIndex<0 || currentBillIndex>=list.length){ alert('No bill selected'); return; }
  const cur = list[currentBillIndex];
  if(cur.kind === 'held'){
    // load into cart and allow edit
    cart = JSON.parse(JSON.stringify(cur.data.cart||[]));
    document.getElementById('pos-disc').value = cur.data.d||0;
    document.getElementById('pos-tax').value = cur.data.t||0;
    document.getElementById('pos-svc').value = cur.data.s||0;
    renderCart();
    closeBillViewer();
    nav('pos');
  } else {
    // load sale for editing
    const sale = cur.data;
    cart = JSON.parse(JSON.stringify(sale.items||[]));
    editingSaleId = sale.id;
    document.getElementById('pos-disc').value = sale.disc||0;
    document.getElementById('pos-tax').value = sale.tax||0;
    document.getElementById('pos-svc').value = sale.svc||0;
    renderCart();
    closeBillViewer();
    nav('pos');
  }
}

/* Return/Refund flow (viewer-based) */
function billReturnCurrent(){
  updateBillIndexDisplay();
  modal('m-bill-view');
}

function executeReturnFromViewer(){
  const list = combinedBills();
  if(currentBillIndex<0 || currentBillIndex>=list.length){ alert('No bill selected'); return; }
  const cur = list[currentBillIndex];
  if(cur.kind !== 'sale'){ alert('Return can only be processed for saved sales. For held bills, recall and cancel instead.'); return; }
  const sale = cur.data;

  const confirmFull = confirm('Process full return for invoice #' + sale.id + '? This will restore stock and adjust balances. Cancel to abort.');
  if(!confirmFull) return;

  // restore stock
  sale.items.forEach(i=>{
    const item = db.items.find(it=>it.id==i.id);
    if(item){
      const qty = i.unit === 'alt' ? (i.qty * (i.conv || 1)) : i.qty;
      item.stock = (parseFloat(item.stock)||0) + qty;
    }
  });

  // adjust customer balance if credit
  if(sale.mode === 'Credit'){
    const c = db.customers.find(x=>x.id==sale.custId); if(c) c.bal = (parseFloat(c.bal)||0) - (sale.net||0);
  } else if(sale.mode === 'Online'){
    const tx = db.transactions.find(t=>t.type==='sale' && t.saleId === sale.id);
    if(tx && tx.party === 'bank' && tx.partyId){
      const b = db.banks.find(bb=>bb.name==tx.partyId);
      if(b) b.bal = (parseFloat(b.bal)||0) - (sale.net||0);
    }
  }

  db.transactions = db.transactions.filter(t => !(t.type==='sale' && t.saleId === sale.id));
  db.sales = db.sales.filter(s=>s.id !== sale.id);
  saveDB();
  alert('Return processed and stock restored.');
  closeBillViewer();
}

/* SETTINGS & MISC PROFIT */
function saveSettings(){
  db.info.name = val('set-name') || db.info.name;
  db.info.addr = val('set-addr') || db.info.addr;

  // logo file is handled via file input and persisted to localStorage
  saveDB();
  alert('Settings saved');
}

function toggleFixedTaxSettings(){
  const mode = document.getElementById('set-tax-mode').value;
  document.getElementById('fixed-tax-settings').style.display = (mode === 'fixed') ? 'block' : 'none';
}

/* Logo upload: image displayed on bill only */
const logoFileInput = document.getElementById('set-logo-file');
if(logoFileInput){
  logoFileInput.addEventListener('change', (event) => {
    const file = event.target.files && event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      const dataUrl = e.target.result;
      localStorage.setItem('billLogo', dataUrl); // persist for bills
      db.info.logo = dataUrl;
      saveDB();
      alert('Logo saved for bill.');
    };
    reader.readAsDataURL(file);
  });
}

/* Add Misc Profit via prompt; store entry and reflect on dashboard/net */
function addMiscProfitPrompt(){
  const desc = prompt('Description for misc profit:');
  if(desc === null) return;
  const amt = parseFloat(prompt('Amount:','0'));
  if(isNaN(amt) || amt <= 0){ alert('Enter a valid amount.'); return; }
  const date = new Date().toISOString().split('T')[0];
  db.miscProfits.push({id: Date.now(), date, desc, amt});
  saveDB();
  alert('Misc profit added.');
}

/* Simple helpers for other CRUD */
function saveContact(type,pref){
  const name = val(pref+'-name');
  const phone = val(pref+'-phone');
  if(!name){ alert('Name required'); return; }
  const list = type === 'customers' ? db.customers : db.suppliers;
  const id = Date.now();
  list.push({id, name, phone, bal:0});
  saveDB();
  closeModal('m-'+(pref==='mc'?'cust':'sup'));
}

function saveBank(){
  const name = val('mb-name'), acc = val('mb-acc'), bal = num('mb-bal')||0;
  if(!name){ alert('Bank name required'); return; }
  db.banks.push({name, acc, bal});
  saveDB();
  closeModal('m-bank');
}

function saveExp(){
  const cat = val('me-cat'), pay = val('me-payee'), desc = val('me-desc'), amt = num('me-amt');
  if(!amt || amt<=0){ alert('Amount required'); return; }
  db.expenses.push({date: new Date().toISOString().split('T')[0], cat, payee:pay, desc, amt});
  saveDB();
  closeModal('m-exp');
}

function saveItem(){
  const id = parseInt(val('mi-id'))||Date.now();
  const code = val('mi-code'), name = val('mi-name'), cost = num('mi-cost'), price = num('mi-price'), stock = num('mi-stock'), alertVal = parseFloat(val('mi-alert')||5), loc = val('mi-loc');
  const u1 = val('mi-u1') || 'Pcs', u2 = val('mi-u2') || '', conv = parseFloat(val('mi-conv')||1);
  const exists = db.items.find(i=>i.id==id);
  if(exists){
    exists.code=code; exists.name=name; exists.cost=cost; exists.price=price; exists.stock=stock; exists.alert=alertVal; exists.loc=loc; exists.u1=u1; exists.u2=u2; exists.conv=conv;
  } else {
    db.items.push({id, code, name, cost, price, stock, alert:alertVal, loc, u1, u2, conv});
  }
  saveDB();
  closeModal('m-item');
}

/* stubs */
function newItem(){ document.getElementById('mi-id').value=''; document.getElementById('mi-code').value=''; document.getElementById('mi-name').value=''; document.getElementById('mi-cost').value=0; document.getElementById('mi-price').value=0; document.getElementById('mi-stock').value=0; modal('m-item'); }
function editItem(id){ const it=db.items.find(x=>x.id==id); if(!it) return; document.getElementById('mi-id').value=it.id; document.getElementById('mi-code').value=it.code||''; document.getElementById('mi-name').value=it.name||''; document.getElementById('mi-cost').value=it.cost||0; document.getElementById('mi-price').value=it.price||0; document.getElementById('mi-stock').value=it.stock||0; document.getElementById('mi-alert').value=it.alert||5; document.getElementById('mi-loc').value=it.loc||''; document.getElementById('mi-u1').value=it.u1||'Pcs'; document.getElementById('mi-u2').value=it.u2||''; document.getElementById('mi-conv').value=it.conv||1; modal('m-item'); }
function saveEmployee(){ const id = val('me-id')||Date.now(); const name = val('me-name'); const role = val('me-role'); if(!name){alert('Name required');return;} db.employees.push({id,name,role}); saveDB(); closeModal('m-emp'); }
function saveAttendance(){ const date = val('att-date'); const emp = val('att-emp'); const status = val('att-status'); const shift = val('att-shift'); db.attendance.push({date,emp,status,shift}); saveDB(); closeModal('m-att'); }
function printPurchaseReport(){ viewReport('sale'); } // placeholder
function printCustomerCreditReport(){ alert('Not implemented in this patch'); }
function printSupplierReport(){ alert('Not implemented in this patch'); }
function openCust(id){ alert('Open customer ledger: '+id); }
function openSup(id){ alert('Open supplier ledger: '+id); }
function editEmployee(id){ alert('Edit employee '+id); }

/* Hard reset */
function hardReset(){
  const pass = prompt('Type password to confirm (1234):');
  if(pass !== '1234'){ alert('Incorrect'); return; }
  db = { info:{name:'Company Name', addr:'Address', logo:''}, items:[], customers:[{id:1,name:'Walk-in',phone:'',bal:0}], suppliers:[], sales:[], expenses:[], banks:[], heldBills:[], transactions:[], employees:[], attendance: [], miscProfits:[] };
  saveDB();
  location.reload();
}

/* helper */
function openBillBrowser(){ updateBillIndexDisplay(); modal('m-bill-view'); }
</script>
</body>
</html>
```
